server {
    listen 8443 ssl default_server;
    http2 on;

#TODO(dtapia) Revisar si la webapp es de tipus SPA (si no ho es, caldra revisar aquesta configuració)
#TODO(dtapia) Generar certificats automatics i gratuits

    ssl_certificate      /certs/webapp.crt;
    ssl_certificate_key  /certs/webapp.key;

    # Configuración restrictiva (A)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

    # Propuesta de nginx
    # ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5

    # http://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_dhparam
    # By default no parameters are set, and therefore DHE ciphers will not be used.
    # https://www.enmilocalfunciona.io/aceleracion-ssl-tls-con-nginx/
    # Los cifrados que utilizan el protocolo Diffie-Hellman son vulnerables debido a que por defecto utiliza parámetros de 1024 bits. Para evitar ésto generamos uno aleatorio de 2048 bits utilizando openssl:
    # openssl dhparam -out /opt/certs/dhparams.pem 2048
    ssl_dhparam /certs/dhparams.pem;

    # Definimos los limites de las sessiones SSL
    ssl_session_timeout 5m;
    ssl_session_cache shared:SSL:1m;
    ssl_session_tickets off;

	gzip on;
	gzip_min_length 1000;
	gzip_types text/plain text/xml application/javascript text/css;

	root /app;

    # https://www.upguard.com/blog/10-tips-for-securing-your-nginx-deployment#toc-4
    # Disable PATCH, TRACE and TRACK
    if ($request_method ~ ^(PATCH|TRACE|TRACK)$) {
        # HTTP 405 Method Not Allowed
        return 405;
    }

    # https://gist.github.com/Friz-zy/3dd2a670d8f14eac717e100d0dc7696f
    # Protect .git and other hidden files
    # Left logging for fail2ban
    location ~ /\. {
        # Cortamos peticiones de scan de vulnerabilidades
        # HTTP 403 Forbidden
        # deny all;

        return 404;
    }

    # https://www.nginx.com/blog/creating-nginx-rewrite-rules/
    # Dropping Requests for Unsupported File Extensions
    location ~* .(aspx|asp|php|jsp|jsa|pl|dll)$ {
        # Alternativa mas segura negando la request
        # HTTP 403 Forbidden
        # deny  all;

        return 404;
    }

    # Se pueden personalizar algunas respuestas, por ejemplo 404, 403, etc...
    error_page 400 401 402 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 501 502 505 506 507 508 510 511 /errors/error.html;
    error_page 403 /errors/403.html;
    error_page 404 /errors/404.html;
    error_page 405 /errors/405.html;
    error_page 500 /errors/500.html;
    error_page 503 /errors/503.html;
    error_page 504 /errors/504.html;

    location ^~ /errors/ {
        # http://nginx.org/en/docs/http/ngx_http_ssi_module.html
        # La pagina error.html tiene etiquetas SSI - A los viejos del lugar les recordara a RXML muy basico...
        ssi on;

        # http://nginx.org/en/docs/http/ngx_http_core_module.html#internal
        internal;

        # http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html
        # El valor por defecto es off
        auth_basic off;

        # Cabeceras HTTP que todas las response deben llevar
        include "/etc/nginx/default.headers";
        root /usr/share/nginx/html;
    }

	# normal routes
	# serve given url and default to index.html if not found
	# e.g. /, /user and /foo/bar will return index.html
	location / {
        include "/etc/nginx/default.headers";
		try_files $uri $uri/index.html /index.html;
	}

	# files
	# for all routes matching a dot, check for files and return 404 if not found
	# e.g. /file.js returns a 404 if not found
	location ~ \.(?!html) {
        # los headers estan definidos en nginx/default.headers
		# add_header Cache-Control "public, max-age=2678400";
		try_files $uri =404;
	}
}
