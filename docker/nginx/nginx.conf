# https://nginx.org/en/docs/ngx_core_module.html#worker_processes
# Defines the number of worker processes.
# With 'auto', Nginx will automatically adjust the number of worker processes to match the number of available CPU cores
worker_processes auto;

# https://nginx.org/en/docs/ngx_core_module.html#pid
# Specify the location of the PID file
pid /var/run/nginx/nginx.pid;

# https://nginx.org/en/docs/ngx_core_module.html#error_log
error_log "/dev/stderr";

# https://nginx.org/en/docs/ngx_core_module.html#worker_rlimit_nofile
# Sets the maximum number of open files per worker process
worker_rlimit_nofile 1024;

# http://nginx.org/en/docs/ngx_core_module.html#pcre_jit
# Enable "Just in time" compilation of regular expressions, improving performance
pcre_jit on;

# Events Block configuration
events {
    # https://dzone.com/articles/tuning-nginx-part-ii
    # Configure the maximum number of simultaneous connections that can be handled by a worker process
    worker_connections 1024;
}

# HTTP Block configuration
http {
    include      mime.types;
    default_type application/octet-stream;

    # http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_temp_path
    client_body_temp_path  "/var/cache/nginx/client_body" 1 2;
    proxy_temp_path        "/var/cache/nginx/proxy" 1 2;
    fastcgi_temp_path      "/var/cache/nginx/fastcgi" 1 2;
    scgi_temp_path         "/var/cache/nginx/scgi" 1 2;
    uwsgi_temp_path        "/var/cache/nginx/uwsgi" 1 2;

    # https://nginx.org/en/docs/http/ngx_http_map_module.html#map_hash_bucket_size
    # https://nginx.org/en/docs/hash.html
    map_hash_bucket_size 256;

    # https://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size
    # Sets the maximum allowed size of the client request body
    # These two should be the same or nginx will start writing large request bodies to temp files
    client_max_body_size 2M;
    client_body_buffer_size 2M;

    map $status $status_text {
        400 'Bad Request';
        401 'Unauthorized';
        402 'Payment Required';
        403 'Forbidden';
        404 'Not Found';
        405 'Method Not Allowed';
        406 'Not Acceptable';
        407 'Proxy Authentication Required';
        408 'Request Timeout';
        409 'Conflict';
        410 'Gone';
        411 'Length Required';
        412 'Precondition Failed';
        413 'Payload Too Large';
        414 'URI Too Long';
        415 'Unsupported Media Type';
        416 'Range Not Satisfiable';
        417 'Expectation Failed';
        418 'I\'m a teapot';
        421 'Misdirected Request';
        422 'Unprocessable Entity';
        423 'Locked';
        424 'Failed Dependency';
        425 'Too Early';
        426 'Upgrade Required';
        428 'Precondition Required';
        429 'Too Many Requests';
        431 'Request Header Fields Too Large';
        451 'Unavailable For Legal Reasons';
        500 'Internal Server Error';
        501 'Not Implemented';
        502 'Bad Gateway';
        503 'Service Unavailable';
        504 'Gateway Timeout';
        505 'HTTP Version Not Supported';
        506 'Variant Also Negotiates';
        507 'Insufficient Storage';
        508 'Loop Detected';
        510 'Not Extended';
        511 'Network Authentication Required';
        default 'Bad Request'; # Change the "Something is wrong" with "Bad Request"
    }

    # https://docs.nginx.com/nginx/admin-guide/load-balancer/using-proxy-protocol/
    # How to configure NGINX to accept the PROXY protocol, rewrite the IP address of a load balancer or proxy to the one
    # received in the PROXY protocol header, configure simple logging of a clientâ€™s IP address, and enable the PROXY
    # protocol between NGINX and a TCP upstream server.

#TODO(dtapia) Revisar com es configura directament sense HAProxy (configuro un?)
    set_real_ip_from   172.31.0.3;

    real_ip_header     X-Forwarded-For;
    real_ip_recursive  off;

    # Log format configuration
    map "$time_local:$msec" $time_local_ms {
        ~(^\S+)(\s+\S+):\d+.(\d+)$ $1.$3$2;
    }
    log_format   main '$realip_remote_addr - $http_x_forwarded_for - $remote_user [$time_local_ms] "$request" '
                      '$status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      '$scheme $host '
                      '$request_id ';

    access_log   "/dev/stdout" main;

    # https://dzone.com/articles/tuning-nginx-part-ii
    # http://nginx.org/en/docs/http/ngx_http_core_module.html#open_file_cache
    # How many files NGINX can keep open and cached in memory
    # We are defining the open_file_cache parameter so that NGINX can cache a maximum of 1024 open files.
    # However, of those files, the cache will be invalidated if they are not accessed within 10 seconds.
    # The open_file_cache_valid parameter is defining a time interval to check if currently cached files are still
    # valid; in this case, every 120 seconds.
    open_file_cache max=1024 inactive=10s;
    open_file_cache_valid 120s;

    # https://dzone.com/articles/nginx-rate-limiting
    # The limit_req_zone directive sets the parameters for rate limiting and the shared memory zone, but it does not
    # actually limit the request rate.
    # For that, you need to apply the limit to a specific location or server block by including a limit_req directive.
    # The same applies for limit_conn_zone.
    limit_req_zone $binary_remote_addr zone=reqaddrlimit:10m rate=90r/s;
    limit_req_status 429;

    # Hide server information
    server_tokens off;

    # Recommended optionals to be set
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;

    gzip               on;
    gzip_http_version  1.1;
    gzip_comp_level    4;
    gzip_proxied       any;
    gzip_types         text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss;

    # Keepalive
    keepalive_timeout   60;

    # http://nginx.org/en/docs/http/ngx_http_core_module.html#types_hash_max_size
    # Double the default value (1024)
    types_hash_max_size 2048;

    # http://nginx.org/en/docs/http/ngx_http_core_module.html#server_names_hash_bucket_size
    # http://nginx.org/en/docs/hash.html
    # Define maximum number of server names hash buckets
    server_names_hash_bucket_size 128;

    ssl_protocols      TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers        HIGH:!aNULL:!MD5;

    absolute_redirect  off;
    port_in_redirect   off;

    # Include other configuration files
    include "/etc/nginx/default.headers";
    include "/etc/nginx/conf.d/*.conf";
}
